.PHONY: all clean distclean install

override _CFLAGS=`pkg-config --cflags gtk+-2.0 vte`
override _LDFLAGS=`pkg-config --libs gtk+-2.0 vte`

ifdef ENABLE_DEBUG
override _CPPFLAGS=-UNDEBUG
override _CFLAGS+=-g -O0 -Wall
else
override _CPPFLAGS=-DNDEBUG
override _CFLAGS+=-O2
endif

SAKURA_SOURCES=$(wildcard src/*.c)
SAKURA_OBJECTS=$(patsubst %.c,%.o,$(wildcard src/*.c))
DEPENDENCIES=$(patsubst %.o,%.d,$(SAKURA_OBJECTS))
POFILES=$(wildcard po/*.po)
MOFILES=$(wildcard po/*.mo)

all: src/sakura localize

src/sakura: $(SAKURA_OBJECTS)
	$(MAKE.binary) $@ $^

clean:
	@rm -rf $(SAKURA_OBJECTS) $(DEPENDENCIES) src/sakura po/*.mo po/*.pot

distclean: clean
	@rm -rf Makefile config.mk config.h 0.log

localize:
	@xgettext -o po/sakura.pot --keyword=_ $(SAKURA_SOURCES)
	@for i in $(POFILES); do \
		msgmerge -U $$i po/sakura.pot 2>/dev/null; \
		msgfmt -o $${i%*.po}.mo $$i 2>/dev/null; \
	done \

DIRMODE="a+rx,u+w"

install: all
	@$(call makedir,$(BINDIR),$(DIRMODE))
	@$(call install_files,src/sakura,$(BINDIR),a=rx)
	@$(call makedir,/usr/share/pixmaps,$(DIRMODE))
	@$(call install_files,terminal-tango.png,/usr/share/pixmaps,a=rx)
	@$(call makedir,$(DATADIR)/share/locale,$(DIRMODE))
	@for i in $(MOFILES); do \
		LINGUA=`basename $${i%%.*}`;\
		echo $(DATADIR)/locale/$${LINGUA}/LC_MESSAGES/$(PROJECT).mo;\
		mkdir -p $(DATADIR)/locale/$${LINGUA}/LC_MESSAGES;;;\
		cp po/$${LINGUA}.mo $(DATADIR)/locale/$${LINGUA}/LC_MESSAGES/$(PROJECT).mo;\
	done \
	
