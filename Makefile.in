.PHONY: all clean distclean install update-po

override _CFLAGS=`pkg-config --cflags gtk+-2.0 vte` --std=c99
override _LDFLAGS=`pkg-config --libs gtk+-2.0 vte`

ifdef ENABLE_DEBUG
override _CPPFLAGS=-UNDEBUG
override _CFLAGS+=-g -O0 -Wall
else
override _CPPFLAGS=-DNDEBUG
override _CFLAGS+=-O2
endif

SAKURA_SOURCES=$(wildcard src/*.c)
SAKURA_OBJECTS=$(patsubst %.c,%.o,$(wildcard src/*.c))
DEPENDENCIES=$(patsubst %.o,%.d,$(SAKURA_OBJECTS))
POFILES=$(wildcard po/*.po)

all: src/sakura 

src/sakura: $(SAKURA_OBJECTS)
	$(MAKE.binary) $@ $^

clean:
	@rm -rf $(SAKURA_OBJECTS) $(DEPENDENCIES) src/sakura po/*.mo po/*.pot

distclean: clean
	@rm -rf Makefile config.mk config.h 0.log

update-po:
	@xgettext -o po/sakura.pot --keyword=_ --keyword=N_ --from-code=utf-8 $(SAKURA_SOURCES)
	@for i in $(POFILES); do \
		msgmerge -U $$i po/sakura.pot 2>/dev/null; \
		msgfmt -o $${i%*.po}.mo $$i 2>/dev/null; \
	done \

DIRMODE="a+rx,u+w"

install: all update-po
	@$(call makedir,$(BINDIR),$(DIRMODE))
	@$(call install_files,src/sakura,$(BINDIR),a=rx)
	@$(call makedir,$(DATADIR)/pixmaps,$(DIRMODE))
	@$(call install_files,terminal-tango.png,$(DATADIR)/pixmaps,a=rx)
	@$(call makedir,$(DATADIR)/locale,$(DIRMODE))
	@$(call makedir,$(DATADIR)/applications,$(DIRMODE))
	@$(call install_files,sakura.desktop,$(DATADIR)/applications,a=rx)
	@for i in po/*.mo; do \
		LINGUA=`basename $${i%%.*}`;\
		echo $(DATADIR)/locale/$${LINGUA}/LC_MESSAGES/$(PROJECT).mo;\
		$(call makedir,$(DATADIR)/locale/$${LINGUA}/LC_MESSAGES,$(DIRMODE));\
		cp po/$${LINGUA}.mo $(DATADIR)/locale/$${LINGUA}/LC_MESSAGES/$(PROJECT).mo;\
	done \
	
